const User=require('../model/user');
const regex=require("../middleware/regex");

const form1=async (req,res)=>{
    try{
        const {iname,atype,rejected}=req.body
        if(!iname)
        {
            return res.json({success:false,msg:"Please enter the institute name"});   
        }
        if(!atype)
        {
            return res.json({success:false,msg:"Please enter the institute type"});   
        }
        if(!rejected)
        {
            return res.json({success:false,msg:"Please enter the rejected field"});   
        }
        if(regex.checkAbbreviation(iname)){
            return res.json({success:false,msg:"Institute name abbreviation cannot be 'IIM', 'IIT', 'IISc', 'NIT', 'IISER', 'IIIT', 'IIEST', 'AICTE', 'UGC', 'MoE', 'GoI'"});   
        }
        const updated= await User.updateOne({email:req.user.email},{
            $set:{
                iname,
                atype,
                rejected
            }});
            if(updated)
            {
               return res.json({success:true,msg:"Form1 submitted successfully",token:req.user.token});
            }
        
            return res.json({success:false,msg:"Institue name not added"});
        
        }
        catch(err){
            console.log(err);
            next(err);
         }

        
    }



const terOperationalExpense=async (req,res)=>{
    try{
    const {ter,oExpense}=req.body
    if(!ter)
    {
     return res.json({success:false,msg:"Please enter the option"});
    }
    const user=req.user
    var fees=user.fees;
    var uter;
    var itype;
    var program=new Array();
    var uoExpense;
    if(ter=="i")
    {
      fees=fees+6.60
      uter=6.60
      itype="Government /Institution setup in J&K / Leh & Ladakh / North Eastern states/PwBD / Institution setup exclusively for women"

    }
    else if(ter="ii")
    {
        uter=0;
        itype="Government/Government Aided Institutions/PPP mode"
    }
    else if(ter="iii")
    {
        fees=fees+8.80
        uter=8.80;
        itype="All other institutions"
    }
    else if(ter="iv")
    {
        fees=fees+2.20
        uter=2.20;
        itype="All Applicants under (i) and (iii) whose applications were rejected and issued Final LoR in the last academy year**"
    }
    if(oExpense=="i")
    {
       fees=fees+100
       uoExpense=100,
       program.push("Engineering and technology")
    }
    else if(oExpense=="ii"||oExpense=="iii"||oExpense=="iv"||oExpense=="v"||oExpense=="vi"||oExpense=="vii")
    {
        fees=fees+50
        uoExpense=50
        if(oExpense=="ii")
        program.push("Planing")
        if(oExpense=="iii")
        program.push("Applied Arts and Crafts")
        if(oExpense=="iv")
        program.push("Design")
        if(oExpense=="v")
        program.push("Hotel Management and Catering Technology")
        if(oExpense=="vi")
        program.push("Computer Apllication (MCA)")
        if(oExpense=="vii")
        program.push("Management")
    }
    programs=[...program]
    console.log(programs)

   const updated= await User.updateOne({email:req.user.email},{
    $set:{
       fees,
       ter:uter,
       oExpense:uoExpense,
       programs,
       itype
    }});
    if(updated)
    {
       return res.json({success:true,msg:"Ter updated",programs:program,token:req.user.token});
    }

    return res.json({success:false,msg:"Ter not recorded"});

}
catch(err){
    console.log(err);
    next(err);
 }
}

const security=async (req,res)=>{
    try{
        const {secDeposit}=req.body
        const user=req.user
        var fees=user.fees;



        function calcharge(i,j){
             if(j==0)
             return 12
            else if(j==1)
            {
                return 15
            }
            else if(j==2||j==4){
                if(i==0)
                return 28 
                else 
                return 12
            } 
            else if(j==3||j==5){
                if(i==0)
                return 35
                else
                return 15
            }
        }
        for(var i=0;i<7;i++)
        {
            for(var j=0;j<=5;j++)
            {
                if(arr[i][j]=="1")
                    {
                        usDeposit=calcharge(i,j)+usDeposit
                        fees=fees+usDeposit
                    }
            }
        }    
       const updated= await User.updateOne({email:req.user.email},{
        $set:{
           fees,
           sDeposit:usDeposit,
           datafull:true
        }});
        if(updated)
        {
           return res.json({success:true,msg:"Security fees updated",token:req.user.token});
        }
    
        return res.json({success:false,msg:"Security fees recorded"});
    
    }
    catch(err){
        console.log(err);
        next(err);
     }
}
module.exports={
    terOperationalExpense,
    security,form1

}