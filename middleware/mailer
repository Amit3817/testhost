const User = require('../model/user');
const bcrypt=require("bcryptjs");
const jwt=require("jsonwebtoken")
const nodemailer=require('nodemailer')

const sent=async (req,res,next)=>{
  try{
  const emailId=req.body.email;
  const transport=nodemailer.createTransport({
    host:"smtp-mail.outlook.com",
    auth:{
        user:process.env.user,
        pass:process.env.pass,
    },
    tls: {
        rejectUnauthorized: false
    }
});
  const old=await User.findOne({email:emailId.toLowerCase()});
  
  const otp=function generateOTP(limit) {
          
    // Declare a digits variable 
    // which stores all digits
    var digits = '0123456789';
    let OTP = '';
    for (let i = 0; i < limit; i++ ) {
        OTP += digits[Math.floor(Math.random() * 10)];
    }
    return OTP;
}
  
  const mailOptions={ 
     from: process.env.user,
     to: emailId,
     subject: 'OTP for ResumeBuilder',
     text: `Your otp is ${otp}`,
 }
 
 const msg2=transport.sendMail(mailOptions)
    if(msg2){
      const token=jwt.sign({email:emailId.toLowerCase()},process.env.secretkey,{expiresIn:"1d"});
      const updated= await User.updateOne({email:emailId.toLowerCase()},{
        $set:{
           otp,
           expireotp:Date.now()+120000,
           token
        }});        
        if(!old)
        return res.status(201).json({success:true,password:false,msg:"User created successfully. Check mail",token});
        else
        {
          return res.status(201).json({success:true,password:false,msg:"Enter otp sent to mail",token});
        }
        
}
  }
catch(err)
{      
  console.log(err);
  console.log('mail not sent');
  next(err);
}
}

module.exports={sent}












